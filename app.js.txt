let students = JSON.parse(localStorage.getItem('students') || '[]');
let selectedStudent = '';
let recognizing = false;
let recognition;
updateStudentSelect();

// Leerling toevoegen
function addStudent() {
    const newStudent = document.getElementById('newStudent').value.trim();
    if(newStudent && !students.includes(newStudent)) {
        students.push(newStudent);
        localStorage.setItem('students', JSON.stringify(students));
        document.getElementById('newStudent').value = '';
        updateStudentSelect();
    }
}

// Dropdown bijwerken
function updateStudentSelect() {
    const select = document.getElementById('studentSelect');
    select.innerHTML = '';
    students.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        select.appendChild(option);
    });
    if(students.length > 0) selectedStudent = students[0];
    select.onchange = () => { selectedStudent = select.value; }
}

// Spraakherkenning
function toggleRecording() {
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if(!isSafari) {
        alert("Inspreken werkt alleen in Safari op iPhone.");
        return;
    }

    if(recognizing) {
        recognition.stop();
        recognizing = false;
        document.getElementById('startStopBtn').textContent = 'Inspreken';
    } else {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'nl-NL';
        recognition.interimResults = true;
        recognition.onresult = (event) => {
            document.getElementById('inputText').value = Array.from(event.results)
                .map(r => r[0].transcript).join('');
        };
        recognition.start();
        recognizing = true;
        document.getElementById('startStopBtn').textContent = 'Stop';
    }
}

// AI-verwerking
async function processText() {
    const inputText = document.getElementById('inputText').value;
    if(!inputText || !selectedStudent) return alert('Vul tekst en leerling in');

    const prompt = `
Zet de onderstaande invoer om naar een gespreksverslag van een leerling.
Gebruik uitsluitend korte bulletpoints.

Naam leerling: ${selectedStudent}
Datum: ${new Date().toLocaleDateString()}
Opleiding / klas:
Bedrijf (BPV):
- Voortgang werk
- Voortgang school
- Priv√© situatie
- Algemeen beeld
- BPV
- Gereedschap
- Kleding
- Afspraken / acties leerling
- Afspraken / acties coach
- Opmerkingen coach

Invoer: ${inputText}
`;

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer JOUW_OPENAI_API_KEY',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: 'gpt-4.1-mini',
            messages: [{role: 'user', content: prompt}],
            max_tokens: 500
        })
    });

    const data = await response.json();
    const content = data.choices[0].message.content;
    document.getElementById('resultText').textContent = content;
}

// Mailen
function sendMail() {
    const body = encodeURIComponent(document.getElementById('resultText').textContent);
    const mailto = `mailto:jouwmail@example.com?subject=Gespreksverslag&body=${body}`;
    window.location.href = mailto;
}